
@{
//ViewBag.Title = "CouponView";
//Layout = "~/Views/Shared/_LayoutEmpty.cshtml";
}

<style type="text/css">
    #divv1 .Wdate {
        width: 100px;
    }
</style>

<script type="text/javascript">

    var id = "@ViewBag.innerid";
    var CardModel = null;
    $(function() {
        BindDDL();
        Init();
    });

    function Init() {

        if (id === "") {
            return;
        }

        $.ajax({
            url: '/api/Rewards/GetCouponById?innerid=' + id,
            type: 'get',
            datatype: 'application/json',
            async: false,
            success: function(data) {

                if (data.errcode !== 0) {
                    alert("获取数据异常！");
                }

                var obj = data.errmsg;
                CardModel = obj;

                $("#title").html(obj.Title);
                $("#logoimg").attr("src", getQiniuUrl(obj.Logourl));
                $("#amount").html(obj.Amount);
                $("#buyprice").html(obj.BuyPrice);
                $("#costprice").html(obj.CostPrice);
                $("#needpoint").html(obj.Needpoint);
                $("#count").html(obj.Maxcount + "/" + obj.Count);
                $("#codetype").html(obj.Codetype);
                $("#createdtime").html(Dateformat(obj.Createdtime, "yyyy-MM-dd HH:mm:ss"));

                if (obj.Vtype === 1) {
                    var vstart = Dateformat(obj.Vstart, "yyyy-MM-dd");
                    var vend = Dateformat(obj.Vstart, "yyyy-MM-dd");
                    $("#vvalue").html(vstart + " 至" + vend);
                    $("#vstart").val(vstart);
                    $("#vend").val(vend);
                } else {
                    $("#vvalue").html("领取后 " + obj.Value1 + " 天开始生效，有效天数为 " + obj.Value2 + " 天");
                    $("#selectvalue1").selectVal(obj.Value1);
                    $("#selectvalue2").selectVal(obj.Value2);
                }

                $("#aDelay").click(ShowDelayDiv);

                if (obj.ProductId == null || obj.ProductId === "") {
                    $("#productid").html("未绑定");
                    $("#productbind").removeClass("hide");
                } else {
                    $("#productid").html(obj.ProductId);
                    $("#productunbind").removeClass("hide");
                }
            }
        });
    }

    function AddStock() {
        var addcount = $("#addcount").val();
        if ($.trim(addcount).length === 0) {
            alert("请填写需要添加的库存数量");
            return;
        }
        var json = { Innerid: id, Count: addcount };
        $.post("/api/Rewards/UpdateStock", json, function(result) {
            alert(result.errmsg);
            location.reload();
        });
    }

    function AddDelay(type) {

        var json = { Innerid: id, Vtype: type };
        var vstart = $("#vstart").val();
        var vend = $("#vend").val();
        var value1 = $("#selectvalue1").val();
        var value2 = $("#selectvalue2").val();
        if (type === 1) {

            if ($.trim(vstart).length === 0) {
                alert("请填写开始生效时间");
                return;
            }
            if ($.trim(vend).length === 0) {
                alert("请填写有效结束时间");
                return;
            }

            json.Vstart = vstart;
            json.Vend = vend;

        } else {
            if ($.trim(value1).length === 0) {
                alert("请填写开始生效时间");
                return;
            }
            if ($.trim(value2).length === 0) {
                alert("请填写有效结束时间");
                return;
            }
            json.Value1 = value1;
            json.Value2 = value2;
        }

        $.post("/api/Rewards/UpdateValidity", json, function (result) {
            alert(result.errmsg);
            location.reload();
        });
    }

    function ShowDelayDiv() {
        $("#vvalue").addClass("hide");
        $("#aDelay").addClass("hide");
        if (CardModel.Vtype === 1) {
            $("#divv1").removeClass('hide');
        } else {
            $("#divv2").removeClass('hide');
        }
    }

    function CancelDelay() {

        $("#vvalue").removeClass("hide");
        $("#aDelay").removeClass("hide");
        $("#divv1").addClass('hide');
        $("#divv2").addClass('hide');
    }

    function BindDDL() {
        var i;
        for (i = 0; i <= 90; i++) {
            $("#selectvalue1").append("<option value='" + i + "'>" + (i === 0 ? "当" : i) + "天</option>");
            $("#selectvalue2").append("<option value='" + i + "'>" + (i === 0 ? "永久有效" : (i + "天")) + "</option>");
        }
        $("#selectvalue2").append("<option value='100'>100天</option>");
    }

    function BindProductID(i) {

        if (i === 1) {
            var productid = $("#txtproductid").val();
            if ($.trim(productid).length === 0) {
                alert("请填写商品ID");
                return;
            }
            var json = { Cardid: id, ProductId: productid };
            $.post("/api/Rewards/BindWechatProduct", json, function(result) {
                alert(result.errmsg);
                location.reload();
            });
        } else {
            if (!confirm("确定解除绑定")) {
                return;
            }
            $.get("/api/Rewards/UnBindWechatProduct?cardid=" + id, function (result) {
                alert(result.errmsg);
                location.reload();
            });
        }

    }

</script>
<div>
    <div style="font-size:18px;font-weight:bold;text-align:center">礼券详情</div>
    <table id="coupon" class="gridtable">
        <tbody>
            <tr>
                <td>标题</td>
                <td id="title"></td>
            </tr>
            <tr>
                <td>Logo</td>
                <td>
                    <img id="logoimg" style="max-width: 150px;max-height:150px" src="" />
                </td>
            </tr>
            <tr>
                <td>面值</td>
                <td id="amount"></td>
            </tr>
            <tr>
                <td>购买价</td>
                <td id="buyprice"></td>
            </tr>
            <tr>
                <td>成本价</td>
                <td id="costprice"></td>
            </tr>
            <tr>
                <td>有效期</td>
                <td>
                    <div>
                        <label id="vvalue"></label>
                        <a href="javascript:;" id="aDelay">延期</a>
                    </div>
                    <div id="divv1" class="margintop hide">
                        固定日期
                        <input id="vstart" class="Wdate" type="text" placeholder="开始日期" onclick="WdatePicker({ minDate: '%y-%M-%d', dateFmt: 'yyyy-MM-dd', isShowToday: false })">-
                        <input id="vend" class="Wdate" type="text" placeholder="结束日期" onclick="WdatePicker({ minDate: '%y-%M-%d', dateFmt: 'yyyy-MM-dd', isShowToday: false })">
                        <input type="button" value="确定" onclick="AddDelay(1);" />
                        <input type="button" value="取消" onclick="CancelDelay();" />
                    </div>
                    <div id="divv2" class="margintop hide">
                        领取后
                        <select id="selectvalue1"></select>
                        生效 ,有效天数
                        <select id="selectvalue2"></select>
                        <input type="button" value="确定" onclick="AddDelay(2);" />
                        <input type="button" value="取消" onclick="CancelDelay();" />
                    </div>
                </td>
            </tr>
        <tr>
            <td>库存</td>
            <td>
                <label id="count"></label>
                <a href="javascript:;" onclick="$('#controls').removeClass('hide');">增加</a>
                <div id="controls" class="margintop hide">
                    <input type="text" id="addcount"/>
                    <input type="button" value="确定" onclick="AddStock();"/>
                    <input type="button" value="取消" onclick="$('#controls').addClass('hide');"/>
                </div>
            </td>
        </tr>
            <tr>
                <td>兑换所需积分</td>
                <td id="needpoint"></td>
            </tr>
            <tr>
                <td>Code展示类</td>
                <td id="codetype"></td>
            </tr>
            <tr>
                <td>创建时间</td>
                <td id="createdtime"></td>
            </tr>
            <tr>
                <td title="绑定微小店中的商品id，用于我们的优惠券和微小店中优惠券对接">商品ID</td>
                <td>
                    <label id="productid"></label>
                    <a href="javascript:;" id="productbind" class="hide" onclick="$('#pcontrols').removeClass('hide');">绑定</a>
                    <a href="javascript:;" id="productunbind" class="hide" onclick="BindProductID(0)">解除绑定</a>
                    <div id="pcontrols" class="margintop hide">
                        <input type="text" id="txtproductid" />
                        <input type="button" value="确定" onclick="BindProductID(1);" />
                        <input type="button" value="取消" onclick="$('#pcontrols').addClass('hide');" />
                    </div>
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <input type="button" value="返回" onclick="getBodyHtml('mainbody', '/rewards/rewards/couponlist',this);" />
                </td>
            </tr>
        </tbody>
    </table>
</div>

