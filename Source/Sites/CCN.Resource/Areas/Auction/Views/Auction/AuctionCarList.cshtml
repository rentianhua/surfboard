@{

}

<script type="text/javascript">

    var custid = "@ViewBag.custid";

    $(function () {
        InitBrand();
        QueryList();
        $("#btnAdd").click(function () {
            getBodyHtml('mainbody', "/auction/auction/auctioncaredit?custid=" + custid);
        });
    });

    //初始化品牌
    function InitBrand() {
        $("#selectbrand").empty();
        $("#selectbrand").append("<option value='0'>请选择</option>");
        $.get("/api/Base/GetCarBrand", function (data) {

            data = data.errmsg;
            $.each(data, function (k, v) {
                $("#selectbrand").append("<option value='" + v.Innerid + "'>" + v.Initial + " " + v.BrandName + "</option>");
            });
        });
    }

    //初始化车系
    function InitSeries(brandid) {
        $("#selectseries").empty();
        $("#selectseries").append("<option value='0'>请选择</option>");
        $.get("/api/Base/GetCarSeries?brandId=" + brandid, function (data) {

            data = data.errmsg;
            $.each(data, function (k, v) {
                $("#selectseries").append("<option value='" + v.Innerid + "'>" + v.SeriesName + "</option>");
            });
        });
    }

    //初始化车型
    function InitModel(seriesid) {
        $("#selectmodel").empty();
        $("#selectmodel").append("<option value='0'>请选择</option>");
        $.get("/api/Base/GetCarModel?seriesId=" + seriesid, function (data) {

            data = data.errmsg;
            $.each(data, function (k, v) {
                $("#selectmodel").append("<option value='" + v.Innerid + "'>" + v.Modelname + "</option>");
            });
        });
    }

    function QueryList() {
        var json = { custid: custid, brand_id: $("#selectbrand").val(), series_id: $("#selectseries").val(), model_id: $("#selectmodel").val(), status: $("#selectstatus").val() };
        $("#auctioncarlist").getPageList(20, "/api/auction/GetAuctionList", json, LoadData);
    }

    function LoadData(data, index) {
        $("#auctioncarlist tbody").empty();
        var str = "";
       // console.log(data);
        $.each(data, function (key, val) {
            str = "";
            str += "<tr>";
            str += "<td>" + (index + key) + "</td>";
            str += "<td>" + (val.model_name == null ? "" : val.model_name.sub(400)) + "</td>";
            str += "<td>" + (val.cityname == null ? "" : val.cityname.sub(400)) + "</td>";
            str += "<td>" + Dateformat(val.publishedtime, "yyyy-MM-dd HH:mm:ss") + "</td>";
            str += "<td>" + Dateformat(val.validtime, "yyyy-MM-dd HH:mm:ss") + "</td>";
            str += "<td>" + ChangeStatusName(val.status) + "</td>";
            str += "<td>" + Dateformat(val.createdtime, "yyyy-MM-dd HH:mm:ss") + "</td>";

            var btn = "<a onclick=\"getBodyHtml('mainbody', '/auction/auction/AuctionCarView?id=" + val.Innerid + "');\" href='javascript:;'>查看</a> ";
            btn += "<a onclick=\"getBodyHtml('mainbody', '/auction/auction/auctioncaredit?carid=" + val.carid + "&id=" + val.Innerid + "');\" href='javascript:;'>审核</a> ";
            btn += "<a onclick=\"getBodyHtml('mainbody', '/auction/auction/AuctionRecordList?auctionid=" + val.Innerid + "');\" href='javascript:;'>竞价记录</a> ";

            if (false) { //待拍
                btn += "<a onclick=\"getBodyHtml('mainbody', '/auction/auction/auctioncaredit?id=" + val.Innerid + "');\" href='javascript:;'>修改</a> ";
                btn += "<a href='javascript:;' onclick=\"PublishAuctionCar('" + val.Innerid + "'," + val.status + ");\">发拍</a> ";
                btn += "<a href='javascript:;' onclick=\"DealAuctionCar('" + val.Innerid + "',this);\">成交</a> ";
                btn += "<a href='javascript:;' onclick=\"DeleteAuctionCar('" + val.Innerid + "',this);\">删除</a> ";
            }
            else if (false) {  //在拍
                btn += "<a href='javascript:;' onclick=\"PublishAuctionCar('" + val.Innerid + "'," + val.status + ");\">撤拍</a> ";
                btn += "<a href='javascript:;' onclick=\"DealAuctionCar('" + val.Innerid + "',this);\">成交</a> ";
            }
            str += "<td>" + btn + "</td></tr>";
            $("#auctioncarlist tbody").append(str);
        });
    }

    function PublishAuctionCar(id, status) {

        if (!confirm("确认" + (status === 1 ? "发拍" : "撤拍") + "?")) {
            return;
        }

        var json = { Innerid: id, status: status };
        $.post("/api/auction/PublishAuctionCar", json, function (delres) {
            if (delres.errcode === 0) {
                QueryList();
            } else {
                alert("操作失败");
            }
        });
    }

    function DeleteAuctionCar(id, obj) {

        $(obj).after($("#deleteDiv").removeClass("hide"));
        $("#delsubmit").unbind("click").bind("click", function () {
            var json = { Innerid: id, deletedesc: $("#deletedesc").val() };
            $.post("/api/auction/DeleteAuctionCar", json, function (delres) {
                if (delres.errcode === 0) {
                    QueryList();
                } else {
                    alert("操作失败");
                }
            });
        });
    }

    //车辆成交
    function DealAuctionCar(id, obj) {

        $(obj).after($("#dealDiv").removeClass("hide"));

        $("#dealsubmit").unbind("click").bind("click", function () {

            var dealedprice = $("#dealedprice").val();
            var dealedtime = $("#dealedtime").val();
            var dealmobile = $("#dealmobile").val();            
            var dealdesc = $("#dealdesc").val();
            
            if ($.trim(dealedprice).length === 0) {
                alert("请填写成交价格！");
                return false;
            }

            if ($.trim(dealedtime).length === 0) {
                alert("请填写成交时间！");
                return false;
            }

            if ($.trim(dealmobile).length === 0) {
                alert("请填写成交人手机号！");
                return false;
            }

            var re = /^[0-9]+([.]{1}[0-9]{1,2})?$/;
            if (!re.test(dealedprice)) {
                alert("价格只能输入数值[最多两位小数]！");
                return false;
            }

            var json = { Innerid: id, dealedprice: dealedprice, dealedtime: dealedtime, dealmobile: dealmobile, dealdesc: dealdesc };

            $.post("/api/auction/DealAuctionCar", json, function (dealres) {
                if (dealres.errcode === 0) {
                    QueryList();
                } else {
                    alert("操作失败");
                }
            });
            return false;
        });
    }

    function ChangeStatusName(status) {
        switch (status) {
            case 0:
                return "已删除";
            case 1:
                return "待拍";
            case 2:
                return "在拍";
            case 3:
                return "成交";
            case 4:
                return "流拍";
            default:

        }
        return "";
    }

</script>
<div style="margin: 0 auto;">
    <div style="font-size: 18px; font-weight: bold; text-align: center">拍卖车辆列表</div>

    <div style="padding-bottom:5px">
        <div class="row">
            <div class="col-lg-9 col-sm-9 col-xs-9">
                <div class="form-group">
                    <label for="" class="col-sm-2 control-label no-padding-right searchLayout">品牌/车系/车型：</label>
                    <div class="col-sm-8">
                        <select id="selectbrand" onchange="InitSeries(this.options[this.options.selectedIndex].value)">
                            <option value="0">请选择</option>
                        </select>
                        <select id="selectseries" onchange="InitModel(this.options[this.options.selectedIndex].value)">
                            <option value="0">请选择</option>
                        </select>
                        <select id="selectmodel" onchange="GetModelInfo(this.options[this.options.selectedIndex].value)">
                            <option value="0">请选择</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-3 col-xs-3">
                <a href="javascript:void(0);" class="btn btn-palegreen shiny" onclick="QueryList();">查询</a>
                <a id="btnAdd" href="javascript:;" class="btn btn-primary shiny">添加</a>
            </div>
        </div>
        <div class="row" style="margin-top:5px">
            <div class="col-lg-9 col-sm-9 col-xs-9">
                <div class="form-group">
                    <label for="" class="col-sm-2 control-label no-padding-right searchLayout">状态：</label>
                    <div class="col-sm-7">
                        <select id="selectstatus" style="width:300px;">
                            <option>请选择</option>
                            <option value="1">待拍</option>
                            <option value="2">在拍</option>
                            <option value="3">成交</option>
                            <option value="4">流拍</option>
                            <option value="0">已删除</option>
                        </select>
                        
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-3 col-xs-3">
                
            </div>
        </div>
    </div>

    <table class="table table-striped table-hover table-bordered" id="auctioncarlist">
        <thead>
            <tr role="row">
                <th>序号</th>
                <th>拍卖车辆(车型)</th>
                <th>车商</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>状态</th>                
                <th>申请时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr></tr>
        </tbody>
    </table>
</div>
<div id="deleteDiv" class="hide" style="background-color: #ccc; margin-top: 8px;padding: 5px">
    描述:
    <input type="text" id="deletedesc" maxlength="200" />
    <input type="button" value="确定" id="delsubmit" />
    <input type="button" value="取消" onclick="$(this).parent().addClass('hide')" />
</div>
<div id="dealDiv" class="hide" style="background-color: #ccc; margin-top: 8px; padding: 5px">
    成交价格:
    <input type="text" id="dealedprice" maxlength="10"/><br/>
    成交时间:
    <input type="text" id="dealedtime" maxlength="10" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })"/><br />
    成交人手机号:
    <input type="text" id="dealmobile" maxlength="11" /><br />
    成交说明:
    <input type="text" id="dealdesc" maxlength="200" /><br />
    <input type="button" value="确定" id="dealsubmit" />
    <input type="button" value="取消" onclick="$(this).parent().addClass('hide')" />
</div>
